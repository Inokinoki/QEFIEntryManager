name: Windows EFI Partition Tests with QEMU

on:
  workflow_run:
    workflows: ["Build Windows x86/x64"]
    types:
      - completed
  workflow_dispatch:

jobs:
  test-windows-efi:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    # Only run if the build workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Download Windows Build Artifacts
      uses: dawidd6/action-download-artifact@v3
      with:
        workflow: cmake-windows-x86-x64.yml
        name: 'QEFI Entry Manager for Windows Qt6.8.3'
        path: windows-app/
        # Download from the triggering workflow run
        run_id: ${{ github.event.workflow_run.id }}
        # If manually triggered, get latest
        if_no_artifact_found: warn

    - name: List Downloaded Artifacts
      run: |
        echo "=== Downloaded Windows Application ==="
        ls -lah windows-app/
        find windows-app/ -type f

    - name: Install QEMU and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          qemu-system-x86 \
          qemu-utils \
          ovmf \
          wget \
          p7zip-full \
          genisoimage \
          ntfs-3g \
          gdisk \
          expect

    - name: Download Windows 11 Evaluation ISO
      run: |
        # Download Windows 11 Enterprise Evaluation (legal for testing, 90 days)
        # This is a direct link to Microsoft's evaluation downloads
        wget -O windows11.iso "https://software-static.download.prss.microsoft.com/dbazure/988969d5-f34g-4e03-ac9d-1f9786c66750/22621.525.220925-0207.ni_release_svc_refresh_CLIENTENTERPRISEEVAL_OEMRET_x64FRE_en-us.iso" || \
        echo "ISO download skipped - using cached version or manual upload"

    - name: Create EFI disk and autounattend.xml
      run: |
        # Create a 25GB disk image for Windows
        qemu-img create -f qcow2 windows-efi.qcow2 25G

        # Create autounattend.xml for automated Windows installation
        cat > autounattend.xml << 'AUTOEOF'
        <?xml version="1.0" encoding="utf-8"?>
        <unattend xmlns="urn:schemas-microsoft-com:unattend">
          <settings pass="windowsPE">
            <component name="Microsoft-Windows-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
              <DiskConfiguration>
                <Disk wcm:action="add">
                  <DiskID>0</DiskID>
                  <WillWipeDisk>true</WillWipeDisk>
                  <CreatePartitions>
                    <CreatePartition wcm:action="add">
                      <Order>1</Order>
                      <Type>EFI</Type>
                      <Size>100</Size>
                    </CreatePartition>
                    <CreatePartition wcm:action="add">
                      <Order>2</Order>
                      <Type>MSR</Type>
                      <Size>128</Size>
                    </CreatePartition>
                    <CreatePartition wcm:action="add">
                      <Order>3</Order>
                      <Type>Primary</Type>
                      <Extend>true</Extend>
                    </CreatePartition>
                  </CreatePartitions>
                  <ModifyPartitions>
                    <ModifyPartition wcm:action="add">
                      <Order>1</Order>
                      <PartitionID>1</PartitionID>
                      <Label>System</Label>
                      <Format>FAT32</Format>
                    </ModifyPartition>
                    <ModifyPartition wcm:action="add">
                      <Order>2</Order>
                      <PartitionID>2</PartitionID>
                    </ModifyPartition>
                    <ModifyPartition wcm:action="add">
                      <Order>3</Order>
                      <PartitionID>3</PartitionID>
                      <Label>Windows</Label>
                      <Letter>C</Letter>
                      <Format>NTFS</Format>
                    </ModifyPartition>
                  </ModifyPartitions>
                </Disk>
              </DiskConfiguration>
              <ImageInstall>
                <OSImage>
                  <InstallTo>
                    <DiskID>0</DiskID>
                    <PartitionID>3</PartitionID>
                  </InstallTo>
                </OSImage>
              </ImageInstall>
              <UserData>
                <AcceptEula>true</AcceptEula>
              </UserData>
            </component>
          </settings>
          <settings pass="oobeSystem">
            <component name="Microsoft-Windows-Shell-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
              <OOBE>
                <HideEULAPage>true</HideEULAPage>
                <SkipMachineOOBE>true</SkipMachineOOBE>
                <SkipUserOOBE>true</SkipUserOOBE>
              </OOBE>
              <UserAccounts>
                <AdministratorPassword>
                  <Value>QEFITest123!</Value>
                  <PlainText>true</PlainText>
                </AdministratorPassword>
              </UserAccounts>
              <FirstLogonCommands>
                <SynchronousCommand wcm:action="add">
                  <Order>1</Order>
                  <Description>Run EFI Partition Tests</Description>
                  <CommandLine>cmd /c D:\run-tests.bat</CommandLine>
                  <RequiresUserInput>false</RequiresUserInput>
                </SynchronousCommand>
                <SynchronousCommand wcm:action="add">
                  <Order>2</Order>
                  <Description>Shutdown after tests</Description>
                  <CommandLine>shutdown /s /t 30</CommandLine>
                  <RequiresUserInput>false</RequiresUserInput>
                </SynchronousCommand>
              </FirstLogonCommands>
            </component>
          </settings>
        </unattend>
        AUTOEOF

        # Create an ISO with autounattend.xml
        mkdir -p auto-iso
        cp autounattend.xml auto-iso/
        genisoimage -o autounattend.iso -J -r auto-iso/

    - name: Prepare Application for Windows VM
      run: |
        # Create a directory structure for the app
        mkdir -p app-iso/QEFIEntryManager

        # Copy all application files
        cp -r windows-app/* app-iso/QEFIEntryManager/

        # Create a test script to run in Windows
        cat > app-iso/run-tests.bat << 'BATEOF'
        @echo off
        echo Starting EFI Partition Tests
        cd /d %~dp0\QEFIEntryManager

        REM Run the application with debug output
        QEFIEntryManager.exe > C:\efi-test-output.txt 2>&1

        REM Export partition information using PowerShell
        powershell -Command "Get-Partition | Where-Object { $_.GptType -eq '{c12a7328-f81f-11d2-ba4b-00a0c93ec93b}' } | Format-List | Out-File C:\efi-partition-info.txt"

        REM Signal test completion
        echo TEST_COMPLETE > C:\test-complete.txt
        BATEOF

        # Create ISO with application
        genisoimage -o app.iso -J -r -V "QEFITEST" app-iso/

    - name: Install Windows in QEMU
      timeout-minutes: 30
      run: |
        # Start Windows installation in QEMU with UEFI
        timeout 25m qemu-system-x86_64 \
          -enable-kvm \
          -cpu host \
          -smp 4 \
          -m 4096 \
          -machine q35 \
          -bios /usr/share/ovmf/OVMF.fd \
          -drive file=windows-efi.qcow2,format=qcow2,if=virtio \
          -cdrom windows11.iso \
          -drive file=autounattend.iso,media=cdrom \
          -device virtio-net-pci,netdev=net0 \
          -netdev user,id=net0 \
          -display none \
          -serial file:install-log.txt \
          -boot d || echo "Installation timeout - continuing to verification"

    - name: Verify EFI Partition Creation
      run: |
        # Mount the QCOW2 image to inspect partitions
        sudo modprobe nbd max_part=8
        sudo qemu-nbd --connect=/dev/nbd0 windows-efi.qcow2

        # Wait for device to be ready
        sleep 2

        # List partitions
        echo "=== Partitions created by Windows installer ==="
        sudo fdisk -l /dev/nbd0 || true
        sudo gdisk -l /dev/nbd0 || true

        # Check for EFI partition (type C12A7328-F81F-11D2-BA4B-00A0C93EC93B)
        echo ""
        echo "=== Looking for EFI System Partition ==="
        sudo blkid /dev/nbd0* || true

        # Mount EFI partition to verify
        if [ -b /dev/nbd0p1 ]; then
          mkdir -p /tmp/efi-mount
          sudo mount /dev/nbd0p1 /tmp/efi-mount || echo "Failed to mount EFI partition"
          echo ""
          echo "=== EFI Partition contents ==="
          sudo ls -lah /tmp/efi-mount/ || true
          sudo umount /tmp/efi-mount || true
        fi

        # Disconnect NBD
        sudo qemu-nbd --disconnect /dev/nbd0

    - name: Start Windows VM for Testing
      timeout-minutes: 15
      run: |
        # Start Windows VM with the application ISO mounted
        # Windows will automatically:
        # 1. Boot
        # 2. Run D:\run-tests.bat via FirstLogonCommands
        # 3. Shutdown after 30 seconds
        timeout 12m qemu-system-x86_64 \
          -enable-kvm \
          -cpu host \
          -smp 4 \
          -m 4096 \
          -machine q35 \
          -bios /usr/share/ovmf/OVMF.fd \
          -drive file=windows-efi.qcow2,format=qcow2,if=virtio \
          -drive file=app.iso,media=cdrom \
          -device virtio-net-pci,netdev=net0 \
          -netdev user,id=net0 \
          -display none \
          -serial file:test-log.txt \
          -boot c || echo "VM completed or timed out"

    - name: Extract Test Results
      if: always()
      run: |
        # Mount the disk again to extract test results
        sudo modprobe nbd max_part=8
        sudo qemu-nbd --connect=/dev/nbd0 windows-efi.qcow2
        sleep 2

        # Mount Windows partition
        if [ -b /dev/nbd0p3 ]; then
          mkdir -p /tmp/windows-mount
          sudo mount -t ntfs-3g -o ro /dev/nbd0p3 /tmp/windows-mount 2>/dev/null || \
          sudo mount -t ntfs -o ro /dev/nbd0p3 /tmp/windows-mount || \
          echo "Failed to mount Windows partition"

          # Extract test results created by run-tests.bat
          echo "=== Checking for test completion marker ==="
          if [ -f /tmp/windows-mount/test-complete.txt ]; then
            echo "Test script completed!"
            cat /tmp/windows-mount/test-complete.txt
          else
            echo "Warning: test-complete.txt not found - tests may not have run"
          fi

          echo ""
          echo "=== Application Output ==="
          if [ -f /tmp/windows-mount/efi-test-output.txt ]; then
            sudo cp /tmp/windows-mount/efi-test-output.txt ./app-output.txt
            cat ./app-output.txt
          else
            echo "No application output found"
          fi

          echo ""
          echo "=== EFI Partition Information from PowerShell ==="
          if [ -f /tmp/windows-mount/efi-partition-info.txt ]; then
            sudo cp /tmp/windows-mount/efi-partition-info.txt ./partition-info.txt
            cat ./partition-info.txt
          else
            echo "No partition info found"
          fi

          sudo umount /tmp/windows-mount || true
        fi

        sudo qemu-nbd --disconnect /dev/nbd0

    - name: Display Test Logs
      if: always()
      run: |
        echo "=== Installation Log ==="
        cat install-log.txt || echo "No install log"
        echo ""
        echo "=== Test Log ==="
        cat test-log.txt || echo "No test log"

    - name: Upload Test Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: windows-efi-test-results
        path: |
          install-log.txt
          test-log.txt
          app-output.txt
          partition-info.txt
        retention-days: 7
